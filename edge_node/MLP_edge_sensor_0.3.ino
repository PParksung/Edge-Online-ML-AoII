#include <Wire.h>
#include <Adafruit_AHTX0.h>
#include "SSD1306Wire.h"
#include <LoRa.h>
#include <math.h>
#include "esp_sleep.h"
#include <Esp.h>

// ==========================================
// 하드웨어 설정 (Heltec V2 / Las Vegas)
// ==========================================

#define OLED_SDA 4
#define OLED_SCL 15
#define OLED_RST 16

SSD1306Wire display(0x3c, OLED_SDA, OLED_SCL);
Adafruit_AHTX0 aht;

// ==========================================
// Rolling Window MLP (12-64-32-2, ReLU)
// ==========================================
#define WINDOW_SIZE 4
#define N_FEATURES  3
#define N_IN   (WINDOW_SIZE * N_FEATURES)  // 12
#define N_H1   64
#define N_H2   32
#define N_OUT  2

float window_buf[WINDOW_SIZE][N_FEATURES];

// ==========================================
// *** Pre_train.py 실행 후 아래 가중치를 교체할 것 ***
// ==========================================
// Scalers
float x_mean[12] = {11.950084f, 34.801339f, 0.518618f, 11.951279f, 34.797155f, 0.518723f, 11.952606f, 34.791896f, 0.518823f, 11.953801f, 34.786517f, 0.518926f};
float x_std[12]  = {5.193260f, 19.256053f, 0.287624f, 5.193064f, 19.255249f, 0.287608f, 5.192706f, 19.253008f, 0.287601f, 5.192256f, 19.250294f, 0.287602f};
float y_mean[2] = {11.954996f, 34.779584f};
float y_std[2]  = {5.191553f, 19.243733f};

float W1[12][64] = {
  {-0.023121f, 0.172080f, 0.130246f, 0.149116f, -0.100390f, -0.165458f, -0.215888f, 0.189449f, 0.108796f, 0.094396f, -0.133442f, 0.231514f, 0.245420f, -0.151054f, -0.164750f, -0.148133f, -0.091783f, 0.026499f, -0.092439f, -0.090339f, 0.051271f, -0.213640f, -0.150671f, -0.008121f, -0.107517f, 0.232886f, -0.178204f, 0.054482f, -0.027934f, -0.199537f, 0.023408f, -0.220745f, -0.132454f, 0.282654f, 0.217214f, 0.017331f, -0.033917f, -0.186045f, 0.128869f, -0.063809f, -0.295457f, -0.018118f, -0.163542f, 0.199103f, -0.060925f, 0.137576f, 0.023872f, -0.086227f, 0.062676f, -0.194431f, 0.209280f, 0.259457f, 0.315428f, 0.218014f, 0.115877f, 0.240923f, -0.244530f, -0.310387f, -0.233148f, -0.025750f, -0.015924f, -0.045452f, 0.285490f, -0.084375f},
  {0.000023f, -0.000065f, -0.113811f, 0.069717f, -0.283454f, 0.209295f, 0.155274f, -0.142814f, -0.368531f, 0.178706f, 0.055857f, 0.132846f, 0.106755f, -0.216637f, -0.150597f, -0.292244f, 0.127327f, 0.064032f, -0.091829f, -0.250604f, -0.073071f, -0.094314f, 0.137971f, 0.088316f, 0.239702f, -0.024431f, -0.161393f, 0.159863f, 0.226054f, -0.013431f, 0.081054f, -0.001014f, -0.051341f, -0.030868f, -0.141871f, -0.172229f, -0.221023f, 0.030212f, -0.104380f, -0.019285f, 0.169395f, -0.059852f, -0.050597f, 0.153932f, -0.155068f, -0.185034f, -0.052538f, -0.123351f, 0.192466f, 0.164910f, 0.108503f, 0.173143f, 0.138347f, -0.182487f, 0.198241f, -0.044263f, 0.151480f, 0.171623f, -0.142324f, -0.187718f, -0.210677f, -0.053704f, 0.185665f, 0.215607f},
  {-0.249313f, -0.054674f, -0.034013f, -0.240954f, -0.167030f, -0.113502f, 0.236163f, -0.118498f, 0.058127f, 0.103833f, -0.120850f, 0.270242f, 0.264534f, -0.105278f, 0.020667f, -0.138345f, -0.103857f, -0.300980f, 0.108604f, 0.016834f, -0.141235f, -0.177678f, 0.189819f, -0.112231f, -0.163653f, 0.047797f, 0.155462f, -0.142542f, 0.091634f, 0.173893f, -0.134961f, 0.176160f, -0.095779f, 0.043916f, 0.014988f, 0.032312f, -0.365298f, 0.166681f, -0.113889f, -0.193226f, -0.331511f, 0.019070f, 0.038605f, -0.289425f, 0.007304f, -0.034631f, 0.056083f, -0.179908f, 0.267090f, -0.062784f, 0.336140f, -0.183829f, -0.088912f, -0.095276f, 0.286686f, 0.183144f, -0.081059f, 0.020682f, 0.141288f, 0.095193f, 0.070229f, -0.273282f, -0.158480f, 0.251812f},
  {0.203413f, 0.020728f, -0.034529f, -0.105469f, 0.102280f, 0.184984f, 0.238181f, 0.183962f, 0.008732f, -0.181098f, -0.183952f, 0.191988f, 0.077948f, -0.193488f, -0.272497f, 0.048169f, -0.202350f, -0.243093f, -0.111119f, 0.104437f, 0.126196f, -0.133697f, 0.130650f, -0.057859f, -0.066418f, 0.217442f, 0.064895f, 0.180402f, 0.059381f, 0.019570f, -0.288363f, -0.071795f, -0.093564f, -0.110793f, 0.276024f, -0.126318f, 0.162023f, 0.034845f, 0.151039f, 0.059169f, 0.088998f, -0.009438f, -0.200569f, -0.008954f, -0.067612f, -0.161589f, 0.212551f, -0.184099f, 0.243026f, 0.263999f, 0.150867f, -0.081726f, -0.212026f, 0.147599f, 0.005285f, 0.201542f, 0.244057f, 0.157197f, -0.105463f, -0.022312f, 0.161757f, -0.132754f, -0.121738f, 0.003857f},
  {0.363044f, 0.134900f, 0.093186f, -0.252118f, 0.075457f, 0.303616f, -0.198251f, 0.069593f, 0.232678f, 0.134993f, 0.114758f, 0.146952f, -0.066802f, -0.069794f, 0.127514f, 0.198189f, 0.188331f, 0.219424f, 0.046656f, 0.015621f, 0.094896f, 0.083675f, 0.179372f, 0.186517f, 0.212900f, -0.038496f, -0.020337f, -0.181323f, 0.108753f, -0.304937f, -0.060910f, 0.005129f, -0.155659f, 0.106322f, -0.108564f, -0.169652f, 0.211410f, -0.109501f, -0.208799f, -0.038333f, 0.083588f, -0.237333f, 0.078108f, -0.219952f, -0.236807f, -0.048776f, 0.096099f, 0.087265f, 0.090773f, 0.252623f, 0.069853f, -0.111004f, 0.196939f, -0.037701f, -0.096784f, -0.347234f, -0.259904f, 0.193757f, 0.146337f, 0.117326f, -0.089462f, -0.171207f, -0.148683f, -0.067255f},
  {0.056121f, 0.086417f, 0.067143f, -0.113670f, 0.209060f, 0.226044f, -0.002135f, -0.027624f, 0.058905f, -0.145527f, -0.129288f, 0.129976f, -0.211624f, -0.132511f, -0.168479f, -0.251932f, 0.159557f, 0.084813f, 0.078067f, -0.278174f, 0.060696f, 0.005383f, -0.219231f, -0.008207f, -0.061647f, 0.055773f, 0.040091f, -0.254788f, -0.119573f, 0.110832f, 0.024164f, 0.205716f, 0.092187f, -0.186423f, -0.262173f, 0.088082f, -0.355234f, 0.034278f, 0.210051f, 0.033857f, -0.114522f, 0.062182f, -0.076357f, -0.004488f, 0.259765f, -0.017288f, 0.160929f, 0.233694f, -0.079613f, -0.230344f, -0.177934f, -0.310341f, -0.157909f, 0.213055f, -0.199974f, -0.134877f, 0.219879f, -0.311997f, 0.083124f, -0.011521f, -0.186432f, 0.021229f, 0.135229f, 0.191295f},
  {0.120674f, 0.175602f, -0.014113f, -0.129491f, 0.097097f, 0.154911f, 0.309492f, 0.000282f, -0.142947f, 0.204570f, -0.105969f, 0.270680f, 0.144701f, 0.035255f, 0.071421f, 0.111337f, -0.163771f, 0.121584f, -0.061424f, 0.260064f, -0.110658f, 0.250295f, -0.011056f, -0.157258f, 0.312138f, -0.115465f, -0.125676f, 0.244813f, 0.185338f, -0.001008f, 0.080027f, -0.067646f, -0.102411f, -0.088449f, 0.132750f, 0.126396f, 0.068568f, 0.113563f, -0.212638f, 0.072170f, -0.164829f, 0.021956f, -0.093242f, 0.138741f, -0.032600f, -0.171559f, -0.099202f, 0.131805f, 0.079886f, -0.193274f, -0.185350f, 0.077448f, -0.250241f, 0.092249f, 0.076565f, -0.320856f, -0.232921f, 0.242171f, -0.055126f, -0.053096f, 0.158110f, 0.218794f, 0.244916f, 0.107538f},
  {0.053847f, -0.197934f, 0.168632f, 0.065894f, -0.108941f, 0.214833f, -0.203319f, 0.015731f, -0.263485f, -0.015890f, -0.282978f, -0.223732f, -0.189470f, 0.129048f, 0.171527f, 0.033495f, 0.240459f, -0.039596f, -0.023716f, 0.159464f, -0.220202f, 0.237805f, -0.209270f, 0.191954f, -0.305216f, 0.262494f, -0.013490f, 0.265795f, -0.156942f, -0.045825f, 0.255829f, 0.000175f, 0.133271f, 0.132444f, -0.006793f, 0.119932f, 0.126792f, 0.162122f, -0.341044f, -0.170746f, 0.180958f, 0.260918f, 0.001130f, 0.027711f, -0.085215f, -0.314525f, -0.031174f, -0.065567f, 0.007388f, -0.269401f, 0.262612f, 0.255369f, 0.162052f, -0.041450f, -0.106096f, 0.187265f, 0.074124f, -0.199476f, 0.214178f, 0.208519f, 0.211110f, 0.127345f, 0.120152f, -0.037884f},
  {0.298841f, 0.190086f, -0.318628f, -0.297002f, -0.118968f, 0.147812f, 0.263861f, -0.134853f, -0.000048f, -0.080865f, 0.247883f, 0.136565f, 0.174092f, 0.023224f, -0.032252f, -0.119763f, -0.260162f, 0.239442f, 0.210824f, 0.219051f, 0.303378f, 0.001041f, 0.052425f, 0.199520f, 0.138924f, -0.116604f, -0.045277f, -0.194907f, 0.219903f, 0.149681f, -0.129952f, 0.114633f, 0.073202f, -0.097577f, -0.183143f, 0.058464f, 0.028480f, 0.136236f, -0.022815f, 0.200228f, -0.033203f, 0.066185f, 0.207745f, 0.036344f, -0.241910f, -0.227459f, 0.188589f, 0.074223f, 0.116046f, -0.197390f, -0.283652f, -0.297393f, -0.018656f, 0.071174f, 0.026397f, -0.084188f, 0.197452f, -0.125285f, 0.005121f, 0.238437f, -0.110259f, 0.048884f, 0.217381f, 0.200551f},
  {-0.125696f, 0.331739f, -0.076639f, -0.283327f, -0.072288f, 0.253239f, 0.051567f, -0.207096f, 0.132884f, -0.331089f, -0.207147f, -0.131624f, -0.295858f, -0.161933f, -0.385230f, 0.110924f, -0.247364f, -0.057335f, 0.308701f, 0.105945f, -0.060375f, -0.061098f, -0.274489f, -0.394995f, -0.247007f, -0.206818f, -0.244177f, -0.171755f, -0.213185f, -0.133627f, -0.227563f, -0.171221f, 0.098165f, -0.053378f, -0.541741f, 0.013500f, 0.213919f, -0.417338f, 0.269875f, 0.284326f, -0.261767f, -0.244599f, 0.173916f, 0.252703f, -0.140142f, -0.238563f, -0.226814f, -0.081370f, 0.152708f, -0.190305f, 0.170534f, 0.246221f, -0.234808f, -0.312558f, 0.044462f, 0.144475f, -0.043918f, -0.074713f, -0.139613f, -0.059672f, 0.090760f, -0.074872f, -0.202325f, -0.144487f},
  {-0.391843f, -0.263980f, -0.153832f, -0.031679f, -0.439205f, 0.242256f, 0.020921f, 0.270025f, -0.099115f, 0.060700f, -0.300669f, -0.052329f, 0.093695f, 0.123656f, -0.026872f, -0.265904f, -0.099314f, -0.056492f, 0.093812f, 0.175675f, -0.061658f, 0.317418f, 0.183117f, -0.146767f, -0.222739f, -0.129972f, -0.172767f, -0.275020f, -0.351744f, -0.211924f, -0.251720f, 0.283736f, -0.348767f, 0.072933f, 0.017152f, 0.457295f, -0.224854f, -0.131367f, 0.392071f, 0.143411f, 0.204224f, -0.189425f, -0.221051f, 0.195114f, 0.183344f, 0.046533f, 0.083903f, -0.118292f, 0.174185f, -0.162874f, -0.054668f, 0.033118f, 0.074513f, -0.242817f, -0.359870f, 0.039444f, -0.096875f, 0.110668f, -0.243492f, 0.020754f, -0.006291f, -0.246308f, -0.074496f, -0.138229f},
  {-0.189945f, 0.227622f, -0.229239f, 0.085601f, -0.222578f, 0.066097f, 0.106449f, -0.092321f, -0.006126f, -0.131645f, -0.185602f, 0.193377f, 0.257786f, 0.262628f, -0.217731f, 0.077102f, 0.204471f, -0.147842f, -0.234610f, 0.100439f, 0.065862f, 0.136897f, -0.260610f, 0.150336f, -0.160309f, -0.227851f, -0.177827f, 0.224207f, 0.069733f, 0.086532f, -0.068297f, 0.227077f, -0.035258f, 0.114218f, -0.044660f, -0.165272f, -0.014970f, -0.105170f, 0.140262f, 0.007411f, -0.253487f, 0.211462f, -0.028740f, 0.016484f, 0.177103f, 0.078255f, -0.110351f, 0.255379f, 0.187029f, -0.127004f, -0.204357f, 0.069102f, 0.069350f, 0.050986f, 0.267421f, 0.107460f, -0.211504f, -0.157149f, -0.071648f, 0.205927f, -0.305102f, -0.105750f, 0.180790f, 0.104684f}
};

float B1[64] = {
  -0.157617f, 0.185080f, -0.379905f, 0.029980f,
  -0.065355f, -0.125030f, 0.102090f, -0.156018f,
  -0.176727f, 0.117828f, 0.109871f, 0.054675f,
  0.196622f, 0.061372f, -0.148561f, -0.101615f,
  -0.091256f, 0.325617f, 0.165946f, -0.055719f,
  0.141012f, 0.251513f, -0.181249f, 0.061135f,
  -0.055897f, 0.063759f, -0.348084f, 0.170039f,
  0.152968f, 0.087612f, 0.086314f, 0.279356f,
  0.037425f, -0.237340f, 0.145610f, 0.267634f,
  -0.049897f, 0.230703f, 0.193656f, 0.164431f,
  0.015624f, -0.231858f, 0.299601f, 0.165620f,
  -0.245571f, 0.293153f, 0.355545f, 0.153526f,
  0.107862f, -0.106166f, -0.217902f, -0.034700f,
  0.302477f, -0.131294f, -0.031150f, -0.069746f,
  0.080664f, 0.194145f, -0.064305f, -0.128582f,
  0.073073f, -0.042269f, -0.001580f, -0.090134f
};

float W2[64][32] = {
  {-0.245444f, -0.235445f, -0.175169f, 0.217396f, 0.093081f, -0.038072f, 0.054951f, -0.112731f, -0.210077f, -0.103067f, -0.061621f, 0.325132f, -0.250953f, -0.003855f, -0.181140f, 0.172409f, 0.092289f, -0.006578f, -0.017715f, 0.033140f, 0.087891f, 0.143230f, -0.125456f, -0.166350f, -0.073451f, -0.071896f, -0.080551f, -0.256477f, 0.109869f, 0.126135f, -0.083132f, 0.151151f},
  {-0.059598f, 0.027470f, -0.163416f, -0.141992f, 0.166607f, 0.230610f, -0.024512f, -0.140890f, 0.063953f, -0.014036f, -0.286055f, -0.120283f, 0.078025f, 0.100271f, -0.216615f, -0.231600f, -0.114877f, -0.010915f, 0.000000f, -0.286323f, 0.144524f, -0.193735f, 0.056797f, -0.202748f, -0.156327f, -0.267820f, 0.079746f, 0.156677f, 0.183115f, 0.004683f, 0.131548f, -0.147182f},
  {-0.049319f, 0.288928f, -0.214067f, -0.030423f, -0.008691f, -0.339851f, -0.281050f, 0.156805f, -0.247573f, 0.081928f, 0.251685f, 0.058591f, -0.500756f, -0.262348f, 0.176909f, 0.015362f, -0.042922f, -0.090122f, 0.011136f, -0.190903f, -0.008032f, 0.052264f, 0.176727f, -0.054720f, 0.226997f, 0.211118f, 0.261944f, -0.000000f, -0.195694f, -0.089522f, -0.184077f, 0.035549f},
  {0.009799f, -0.127345f, -0.237233f, 0.277844f, 0.234257f, 0.032638f, -0.148611f, -0.088996f, -0.200154f, 0.181795f, -0.183990f, -0.086094f, -0.069972f, -0.005917f, 0.100305f, 0.148385f, -0.158310f, -0.330017f, -0.132396f, 0.233648f, 0.041506f, 0.035127f, -0.035360f, 0.063056f, -0.141498f, 0.239196f, -0.193095f, -0.068498f, 0.019660f, -0.067040f, -0.129857f, 0.191819f},
  {-0.234238f, -0.042469f, -0.245490f, 0.034773f, -0.078128f, -0.018506f, -0.128707f, -0.158909f, -0.031063f, 0.011697f, 0.118631f, 0.337950f, 0.155122f, -0.089899f, -0.159522f, -0.127082f, 0.087361f, -0.253815f, 0.000000f, -0.089759f, 0.125566f, 0.149006f, -0.185132f, -0.196497f, 0.144061f, 0.032633f, 0.103997f, -0.069337f, -0.117834f, 0.301505f, 0.154452f, 0.167548f},
  {-0.080494f, 0.051225f, 0.000617f, -0.314437f, 0.208657f, -0.186423f, 0.239667f, 0.028342f, -0.149371f, 0.048647f, 0.165339f, 0.110483f, 0.194657f, 0.055534f, 0.078923f, 0.190375f, -0.167274f, 0.031001f, -0.060314f, 0.290174f, 0.220489f, -0.150484f, 0.133089f, 0.205785f, -0.129070f, -0.023486f, 0.214931f, -0.183043f, 0.108238f, -0.084076f, 0.280974f, 0.215700f},
  {0.218087f, 0.028000f, 0.184728f, 0.126275f, -0.041814f, 0.157484f, -0.117543f, 0.057588f, -0.117386f, -0.396688f, -0.139132f, 0.095717f, -0.135110f, 0.083699f, -0.158439f, -0.073965f, -0.009996f, -0.043697f, -0.000000f, -0.061130f, 0.133826f, 0.100722f, -0.162225f, -0.247894f, 0.228181f, -0.369896f, 0.147773f, -0.021452f, 0.212202f, 0.158662f, 0.253069f, -0.109641f},
  {0.185339f, -0.029810f, 0.047573f, 0.049518f, 0.256600f, 0.211190f, 0.251173f, 0.024568f, -0.067261f, 0.166816f, -0.113354f, -0.190718f, -0.211016f, -0.259565f, -0.014208f, 0.006087f, -0.555045f, -0.400363f, -0.000000f, -0.181815f, -0.233255f, 0.196902f, -0.087651f, 0.347127f, 0.007292f, -0.065825f, -0.043345f, 0.135270f, 0.179049f, -0.019281f, 0.095831f, -0.065413f},
  {0.095076f, -0.182468f, 0.238728f, 0.205750f, -0.007564f, 0.077547f, -0.147719f, -0.185336f, -0.224748f, -0.016875f, 0.127562f, 0.008203f, -0.121786f, 0.318843f, 0.272225f, 0.088434f, 0.330653f, -0.282806f, -0.000000f, 0.223578f, 0.298971f, -0.079094f, 0.123282f, -0.158099f, -0.166120f, -0.097277f, 0.120230f, 0.037831f, -0.086623f, 0.219947f, 0.063731f, 0.054561f},
  {0.199884f, 0.248746f, 0.228814f, 0.263442f, 0.099769f, 0.001831f, -0.209652f, -0.021691f, -0.087330f, -0.222644f, 0.134601f, 0.002392f, -0.276850f, -0.182827f, 0.145688f, -0.191598f, 0.158683f, 0.007590f, -0.015580f, 0.008797f, 0.113235f, -0.072541f, 0.101088f, 0.048132f, -0.082552f, 0.197476f, 0.201494f, 0.049519f, 0.133038f, 0.048842f, 0.134337f, 0.163927f},
  {0.026499f, 0.103772f, 0.000072f, 0.148961f, -0.150337f, 0.197679f, 0.160398f, -0.243271f, 0.156378f, -0.205525f, -0.039106f, 0.116940f, -0.150893f, 0.143457f, 0.183047f, 0.001238f, -0.219471f, -0.245940f, 0.034887f, 0.252215f, 0.083215f, -0.085841f, 0.001636f, 0.029424f, 0.199509f, -0.158741f, 0.098801f, 0.138496f, 0.204646f, -0.039626f, 0.067264f, 0.287717f},
  {-0.184570f, 0.250915f, 0.098670f, -0.232180f, -0.088629f, 0.053095f, -0.138524f, 0.025776f, -0.148276f, 0.127996f, -0.161285f, 0.187457f, 0.163579f, 0.205733f, 0.159479f, -0.179304f, 0.088029f, -0.303737f, 0.000000f, -0.048100f, -0.004946f, 0.059307f, 0.044996f, -0.057536f, -0.067311f, 0.349174f, -0.068786f, -0.049710f, -0.188170f, 0.202677f, 0.068582f, -0.103353f},
  {-0.205269f, 0.152998f, 0.100660f, 0.003094f, 0.252588f, -0.231211f, 0.077009f, 0.192058f, -0.061009f, 0.069749f, 0.103199f, -0.140531f, 0.131940f, -0.099091f, 0.270298f, -0.108621f, -0.202091f, -0.127166f, 0.000000f, -0.102084f, 0.172021f, -0.105388f, 0.176362f, -0.112246f, 0.269030f, -0.066993f, 0.108156f, 0.129729f, 0.090881f, 0.083245f, -0.250626f, -0.096266f},
  {0.120318f, 0.076516f, 0.095326f, -0.015954f, -0.182111f, -0.192839f, 0.111478f, 0.045861f, -0.120894f, -0.116814f, -0.191696f, 0.026046f, 0.010134f, 0.128234f, -0.071414f, -0.002018f, -0.289527f, 0.035380f, -0.055529f, 0.010820f, 0.135205f, -0.050668f, 0.015746f, 0.200194f, 0.164518f, -0.097313f, -0.013785f, -0.171199f, -0.144856f, 0.301868f, -0.023232f, 0.047743f},
  {0.045769f, 0.127359f, 0.003601f, -0.199848f, -0.050552f, -0.016663f, -0.221055f, -0.029949f, -0.248519f, -0.228650f, -0.015225f, -0.198138f, -0.002303f, 0.041087f, 0.205036f, -0.129004f, -0.166266f, -0.266075f, 0.040746f, 0.120060f, -0.349458f, 0.106954f, -0.232268f, 0.044317f, 0.129217f, 0.269672f, 0.089962f, -0.000000f, -0.105876f, 0.182237f, -0.195635f, 0.208564f},
  {0.079528f, 0.132778f, -0.055565f, 0.125548f, 0.017027f, 0.183654f, -0.331167f, -0.154736f, -0.074743f, -0.158034f, 0.211677f, -0.106849f, 0.260110f, -0.047922f, -0.184066f, 0.137259f, 0.175531f, 0.230178f, 0.009404f, 0.160350f, -0.116282f, 0.250413f, 0.314216f, 0.095226f, -0.163761f, 0.238931f, -0.180393f, -0.227242f, -0.115267f, 0.123920f, 0.194667f, 0.154354f},
  {0.099265f, -0.027825f, -0.089412f, -0.024934f, 0.251936f, -0.233626f, 0.164872f, 0.050524f, -0.048518f, -0.149943f, 0.007853f, 0.171563f, 0.198044f, -0.062274f, -0.090447f, 0.038127f, 0.178881f, -0.199309f, 0.038698f, 0.070976f, 0.155503f, -0.086187f, 0.095746f, 0.206302f, -0.096798f, -0.127134f, 0.189032f, -0.145992f, 0.140685f, -0.093697f, -0.084774f, 0.195040f},
  {-0.011144f, 0.034902f, 0.008586f, -0.015536f, -0.134879f, -0.069453f, 0.261007f, -0.073000f, 0.094916f, -0.084606f, 0.141848f, -0.164743f, 0.271675f, -0.034661f, -0.096038f, -0.195715f, -0.192593f, 0.017386f, -0.080249f, 0.244468f, -0.009782f, -0.136986f, 0.042316f, 0.139127f, -0.093008f, -0.161723f, -0.275106f, 0.041279f, 0.059795f, -0.122643f, 0.244075f, 0.128379f},
  {0.195135f, 0.136251f, -0.043934f, -0.308056f, -0.131282f, -0.155103f, 0.066154f, 0.282808f, -0.100487f, -0.107329f, -0.223412f, 0.318427f, -0.015946f, 0.074652f, -0.282403f, -0.336578f, 0.186054f, 0.264869f, -0.002178f, 0.413379f, 0.063198f, 0.206086f, -0.073330f, -0.005696f, -0.061644f, -0.014984f, -0.050908f, -0.325822f, -0.042467f, 0.045863f, -0.023469f, 0.013544f},
  {0.065141f, -0.191213f, 0.138172f, -0.132187f, 0.189142f, -0.223310f, 0.131128f, 0.144775f, 0.148648f, 0.195071f, 0.163803f, 0.081021f, 0.177894f, 0.037910f, -0.285606f, 0.283311f, 0.041892f, -0.239228f, -0.070064f, 0.064230f, 0.002105f, 0.098442f, -0.192836f, 0.155838f, 0.207908f, -0.009961f, 0.295117f, -0.048963f, 0.177707f, 0.077215f, 0.136775f, 0.148491f},
  {0.236756f, -0.039899f, -0.078313f, 0.020128f, 0.112274f, 0.187241f, 0.201498f, -0.046767f, 0.183914f, -0.265786f, 0.047540f, -0.096767f, -0.155796f, -0.050909f, -0.001393f, 0.122027f, -0.033683f, -0.048510f, -0.113761f, -0.042691f, -0.070373f, -0.210317f, 0.019305f, 0.308279f, 0.097864f, -0.103799f, -0.051749f, 0.173257f, -0.008152f, 0.044142f, -0.213275f, 0.105325f},
  {-0.043801f, -0.005834f, 0.100824f, -0.144654f, 0.093789f, 0.076592f, 0.198444f, 0.160451f, 0.188203f, -0.218385f, -0.117876f, -0.255143f, 0.069301f, 0.156056f, -0.086332f, 0.250946f, -0.257029f, 0.250285f, -0.072885f, -0.150457f, 0.006226f, -0.208733f, -0.107499f, -0.056900f, 0.191333f, 0.045875f, -0.120917f, 0.014513f, 0.065682f, -0.192650f, -0.000057f, -0.219302f},
  {-0.141150f, 0.134357f, -0.104965f, 0.178742f, 0.142822f, -0.230578f, -0.062514f, -0.089623f, 0.172490f, -0.157155f, 0.205668f, 0.062968f, -0.410886f, -0.061362f, 0.304290f, 0.102018f, 0.189306f, 0.204796f, -0.000000f, -0.317216f, 0.003763f, -0.122858f, 0.204439f, 0.247828f, -0.036609f, -0.072283f, 0.235857f, -0.000000f, 0.112087f, -0.104553f, 0.152559f, -0.206328f},
  {0.034202f, -0.011350f, 0.030441f, -0.111720f, 0.122999f, 0.183444f, -0.144596f, -0.166475f, -0.243039f, 0.054176f, 0.070709f, 0.011895f, -0.107287f, -0.076288f, 0.075892f, -0.001497f, 0.225326f, -0.120565f, 0.071432f, -0.044414f, 0.021914f, -0.007334f, 0.053543f, 0.250819f, -0.155627f, -0.190934f, 0.129218f, 0.046631f, -0.138999f, -0.217038f, -0.116820f, 0.216857f},
  {-0.166250f, -0.102618f, -0.167178f, 0.197791f, -0.211627f, -0.014318f, -0.344051f, 0.164209f, -0.172235f, 0.000470f, 0.229773f, 0.018855f, -0.053013f, -0.129247f, -0.023059f, 0.072585f, 0.339225f, 0.292851f, 0.007967f, -0.000729f, 0.021966f, -0.294413f, 0.014056f, 0.241588f, -0.102890f, 0.098285f, -0.064430f, 0.001783f, -0.234940f, 0.047960f, 0.204172f, -0.025741f},
  {0.059548f, 0.168092f, 0.115235f, 0.123368f, -0.036880f, -0.158667f, 0.189013f, 0.137546f, 0.017979f, 0.147576f, 0.050592f, 0.101160f, -0.419819f, 0.102657f, -0.114337f, 0.208163f, 0.096531f, -0.003604f, -0.197862f, -0.170239f, -0.458185f, -0.200968f, -0.279726f, 0.255481f, 0.116454f, -0.096209f, -0.106427f, -0.241869f, -0.046631f, 0.189734f, 0.051942f, 0.094586f},
  {0.233001f, 0.189971f, -0.109777f, 0.293893f, -0.154132f, 0.091431f, -0.090586f, 0.179468f, 0.105286f, 0.098523f, 0.177046f, -0.080399f, -0.324170f, -0.112105f, -0.144183f, 0.135965f, -0.128894f, 0.289481f, 0.040703f, -0.018770f, -0.147982f, 0.179908f, 0.182648f, 0.050785f, 0.088840f, 0.016353f, -0.019937f, -0.008357f, -0.080709f, -0.132665f, -0.145082f, -0.118651f},
  {-0.290740f, -0.159826f, 0.152454f, 0.215326f, 0.245197f, -0.081601f, -0.001151f, -0.049730f, -0.060554f, -0.364700f, 0.131836f, -0.095568f, -0.065947f, 0.041793f, -0.089995f, -0.169871f, 0.143835f, -0.069760f, -0.000000f, -0.007583f, -0.289322f, 0.011835f, 0.196966f, -0.061112f, 0.012565f, -0.263277f, -0.159771f, -0.288926f, 0.051096f, -0.036533f, -0.117569f, 0.264058f},
  {0.092223f, 0.089888f, -0.173289f, 0.130819f, 0.022198f, -0.062950f, -0.145799f, 0.099591f, -0.024218f, -0.296165f, 0.104917f, -0.004154f, 0.055905f, 0.080618f, 0.190368f, -0.270893f, 0.009055f, -0.161161f, -0.001205f, -0.296150f, 0.111415f, -0.263008f, -0.019663f, -0.090064f, -0.143614f, -0.503038f, 0.146175f, 0.125282f, 0.185876f, 0.089132f, -0.312136f, 0.194690f},
  {-0.046623f, 0.221169f, -0.201066f, -0.004834f, -0.147358f, -0.124961f, 0.199973f, 0.013023f, -0.085223f, -0.128680f, -0.021728f, 0.147502f, 0.198140f, 0.182629f, 0.180388f, -0.082892f, 0.055417f, 0.042480f, -0.102206f, 0.177768f, -0.229619f, 0.253128f, -0.049033f, 0.144417f, 0.119906f, -0.134950f, 0.060397f, 0.020926f, -0.236372f, 0.046758f, -0.094775f, 0.203879f},
  {-0.016704f, 0.110763f, -0.260680f, -0.106021f, 0.132741f, -0.223846f, -0.199554f, -0.230684f, 0.224347f, -0.015291f, -0.043645f, -0.134549f, -0.095959f, 0.105150f, 0.123190f, -0.153748f, -0.173765f, -0.475145f, 0.052028f, 0.150524f, -0.116486f, -0.271206f, -0.240827f, 0.245593f, -0.019046f, 0.167295f, -0.033299f, -0.000000f, -0.176589f, -0.130163f, 0.043520f, 0.158454f},
  {0.091398f, 0.049128f, -0.139425f, 0.234106f, 0.182225f, -0.143596f, 0.281201f, 0.111668f, 0.041162f, 0.094303f, 0.181244f, 0.077649f, -0.216672f, -0.119561f, 0.262149f, -0.126349f, -0.113109f, 0.084496f, -0.036654f, 0.039840f, 0.212157f, -0.140363f, -0.248244f, -0.141655f, 0.219783f, 0.017169f, -0.087611f, 0.060284f, 0.128979f, 0.075715f, 0.253072f, -0.123560f},
  {0.086473f, -0.022726f, 0.091751f, 0.126477f, 0.115663f, 0.089431f, -0.140424f, -0.017159f, 0.254970f, 0.175077f, -0.229528f, -0.178806f, -0.114045f, 0.107288f, 0.140879f, -0.175785f, 0.019920f, 0.009648f, 0.083843f, 0.045891f, 0.014388f, 0.012607f, -0.137322f, 0.012252f, 0.137307f, 0.143827f, 0.024662f, 0.112959f, -0.195305f, 0.042469f, -0.233399f, -0.032031f},
  {0.124540f, 0.249011f, -0.184890f, -0.108677f, 0.149208f, -0.007478f, 0.002231f, 0.107276f, 0.210529f, -0.104524f, -0.069155f, 0.135950f, 0.014802f, -0.327311f, 0.191012f, -0.231598f, 0.197821f, -0.163671f, 0.160130f, 0.034967f, -0.349450f, 0.083530f, -0.066185f, 0.184028f, 0.281617f, -0.110490f, -0.081019f, 0.053955f, 0.175062f, -0.027678f, -0.038040f, -0.006225f},
  {0.123014f, -0.221348f, 0.009055f, 0.163356f, 0.199898f, -0.186826f, 0.140298f, -0.030754f, 0.127367f, -0.130321f, 0.123982f, 0.022776f, -0.013644f, -0.052938f, 0.264917f, 0.207621f, -0.107622f, 0.215421f, 0.000000f, -0.391784f, -0.461507f, -0.144832f, 0.082270f, 0.171599f, 0.159474f, -0.027430f, -0.094630f, -0.344072f, -0.045554f, 0.048983f, -0.269177f, -0.037351f},
  {0.135559f, 0.198110f, 0.400620f, 0.102654f, 0.233287f, -0.222756f, 0.236861f, 0.193393f, -0.193261f, 0.045439f, 0.094390f, -0.065216f, 0.024531f, -0.033102f, -0.103767f, 0.061322f, -0.242883f, -0.123068f, 0.000000f, 0.302613f, -0.199806f, -0.011475f, -0.130449f, 0.363957f, -0.097273f, 0.157779f, 0.233089f, 0.053666f, -0.226037f, 0.095381f, 0.083805f, -0.087482f},
  {-0.185676f, -0.264686f, 0.070833f, 0.069553f, -0.080660f, 0.180428f, 0.099485f, -0.219398f, 0.139073f, -0.336792f, 0.098807f, 0.087150f, 0.230885f, -0.117577f, -0.171688f, -0.155534f, -0.135467f, -0.020033f, -0.000000f, 0.075798f, -0.488564f, 0.181651f, -0.035651f, 0.118954f, -0.140812f, 0.025098f, -0.199164f, -0.275777f, 0.260379f, -0.034538f, 0.032212f, 0.035192f},
  {-0.077945f, 0.245013f, -0.127665f, 0.128312f, 0.283596f, -0.012708f, 0.260741f, -0.182108f, -0.058451f, -0.201366f, 0.169955f, 0.238624f, -0.151158f, 0.018877f, -0.099880f, 0.074865f, -0.046596f, 0.307114f, 0.030489f, -0.190376f, -0.185789f, -0.159202f, -0.186033f, -0.080028f, 0.226063f, 0.014122f, 0.037268f, -0.235678f, 0.114500f, 0.086329f, -0.201148f, 0.098364f},
  {0.044376f, -0.168784f, 0.090289f, -0.060718f, -0.088112f, 0.196698f, 0.325811f, 0.126796f, -0.016340f, -0.024634f, -0.049861f, 0.031081f, -0.204451f, -0.023551f, 0.222448f, -0.028160f, -0.261124f, 0.060455f, 0.000000f, 0.130475f, -0.179863f, -0.015285f, 0.106042f, 0.118022f, -0.134557f, 0.202768f, 0.205937f, 0.133118f, -0.113025f, -0.053569f, 0.402377f, 0.161480f},
  {-0.168633f, -0.185215f, 0.116817f, -0.004940f, 0.073499f, -0.024159f, -0.116961f, 0.216003f, 0.206900f, -0.107264f, 0.069497f, 0.231434f, -0.092094f, -0.005524f, -0.103376f, 0.147904f, 0.040749f, 0.007052f, 0.000000f, -0.120925f, 0.138626f, 0.116171f, -0.145161f, 0.149880f, 0.162295f, -0.114737f, 0.199633f, 0.150475f, -0.082986f, 0.152410f, -0.034064f, -0.267663f},
  {-0.152057f, 0.214809f, 0.109506f, -0.151243f, -0.012197f, 0.046536f, -0.206585f, 0.212809f, 0.136480f, -0.169217f, 0.250863f, -0.062842f, 0.233000f, 0.045965f, 0.096383f, -0.156078f, 0.170959f, -0.123870f, -0.153679f, -0.214422f, 0.016557f, 0.016412f, 0.117223f, 0.209996f, -0.170521f, 0.163277f, -0.246050f, 0.116044f, 0.147339f, 0.016711f, 0.139673f, -0.096120f},
  {-0.095007f, 0.132376f, -0.096998f, -0.014229f, -0.141254f, 0.104649f, -0.121575f, -0.214641f, -0.074733f, 0.093985f, -0.237548f, -0.093525f, -0.206974f, -0.038547f, -0.054459f, 0.053235f, 0.114463f, 0.267173f, -0.073141f, 0.169673f, 0.124009f, 0.184443f, 0.036432f, -0.272998f, 0.077932f, 0.384407f, 0.120092f, -0.185708f, -0.189464f, 0.262698f, 0.103411f, 0.316690f},
  {-0.128476f, 0.080513f, 0.099006f, -0.068056f, -0.091489f, -0.147892f, -0.156392f, 0.023083f, 0.141491f, 0.062628f, 0.130577f, 0.141334f, 0.240954f, 0.107704f, -0.127702f, 0.151950f, 0.093928f, 0.040708f, -0.182147f, 0.064264f, -0.053075f, 0.224289f, -0.021213f, -0.061207f, 0.269645f, -0.292162f, -0.051738f, -0.300119f, 0.111373f, 0.209101f, 0.054237f, 0.182395f},
  {-0.080094f, 0.202733f, 0.186463f, 0.103406f, -0.225771f, 0.226979f, 0.205140f, -0.049203f, 0.168299f, -0.019346f, 0.136008f, -0.140267f, 0.134804f, 0.051255f, -0.066257f, -0.077506f, -0.291590f, -0.019223f, -0.000000f, -0.028664f, -0.137088f, -0.007360f, 0.136300f, -0.178898f, 0.268777f, 0.193922f, 0.128523f, 0.007308f, 0.264899f, -0.150311f, -0.106734f, -0.209059f},
  {0.105060f, -0.183217f, -0.016759f, 0.267713f, 0.199361f, -0.067008f, -0.173300f, 0.114098f, -0.063375f, -0.152591f, -0.110864f, 0.150615f, 0.098755f, 0.120121f, 0.236688f, 0.115552f, -0.026593f, 0.096271f, -0.000000f, -0.151839f, 0.160412f, 0.056482f, 0.166846f, -0.005256f, 0.101505f, -0.042862f, 0.058841f, 0.176541f, -0.161515f, 0.009637f, 0.010291f, -0.048077f},
  {-0.055448f, 0.113450f, 0.188349f, 0.102930f, 0.159346f, 0.026225f, 0.150660f, -0.090217f, -0.089138f, -0.063058f, 0.023910f, -0.246623f, -0.081288f, -0.140519f, 0.272809f, -0.045080f, -0.031609f, -0.036840f, 0.035390f, -0.094352f, -0.247174f, 0.004325f, -0.296175f, -0.210772f, -0.097308f, -0.115494f, -0.236814f, -0.162297f, 0.125357f, 0.117570f, -0.014884f, -0.034179f},
  {0.201777f, 0.002209f, -0.172654f, 0.089450f, -0.128256f, -0.118418f, 0.083834f, 0.221248f, -0.040559f, 0.088216f, 0.284694f, -0.193111f, -0.170663f, -0.105728f, 0.009659f, 0.008232f, 0.148347f, 0.140144f, 0.033431f, -0.125986f, 0.153794f, 0.143206f, 0.126095f, -0.169071f, 0.123590f, -0.255292f, -0.132267f, -0.298612f, -0.014488f, 0.121208f, -0.211404f, -0.054004f},
  {-0.012105f, -0.022067f, -0.161968f, -0.036827f, 0.148249f, -0.215648f, -0.146857f, -0.042215f, 0.219591f, 0.060092f, 0.177020f, 0.022644f, -0.013004f, -0.266851f, 0.125768f, 0.233213f, 0.025599f, 0.268189f, 0.081415f, -0.299455f, 0.252562f, -0.200156f, -0.026311f, -0.116488f, -0.202579f, -0.656420f, -0.108734f, -0.025498f, -0.003876f, -0.208829f, -0.172895f, 0.163255f},
  {-0.020553f, 0.149824f, 0.170328f, 0.122633f, 0.127421f, -0.080848f, 0.124975f, -0.049977f, -0.160941f, 0.193307f, -0.033030f, 0.151987f, 0.159492f, 0.166210f, 0.222031f, 0.009693f, -0.121945f, 0.089543f, 0.000000f, 0.053489f, 0.088533f, 0.111701f, -0.052585f, -0.162290f, 0.014538f, -0.095533f, 0.220926f, -0.109140f, -0.170908f, -0.274545f, 0.122815f, 0.018259f},
  {-0.055314f, -0.217639f, -0.023514f, 0.062198f, 0.084497f, 0.057119f, -0.130015f, -0.062103f, 0.265153f, -0.076629f, 0.094229f, -0.204333f, -0.014455f, -0.266984f, 0.024557f, 0.233109f, -0.029326f, -0.012003f, 0.000000f, -0.078703f, -0.276212f, -0.248652f, 0.117082f, -0.018038f, -0.162606f, 0.224698f, -0.094862f, -0.000000f, -0.088611f, 0.246304f, 0.102118f, 0.183112f},
  {0.231873f, -0.131763f, 0.288617f, 0.087979f, -0.060099f, -0.050225f, -0.047063f, -0.180806f, 0.070175f, -0.047636f, 0.069673f, 0.221419f, -0.060034f, -0.051379f, -0.139976f, -0.117520f, -0.175076f, 0.054429f, 0.000000f, 0.247217f, -0.385501f, -0.026228f, 0.111736f, -0.194839f, -0.049690f, 0.040532f, 0.016926f, 0.019305f, 0.189611f, 0.078289f, 0.080867f, 0.092113f},
  {0.027538f, -0.174291f, -0.013277f, -0.189324f, -0.028329f, 0.022992f, -0.127764f, 0.206199f, 0.264995f, -0.069416f, -0.021751f, 0.148724f, -0.182520f, 0.175621f, -0.167880f, 0.130711f, -0.147126f, 0.201171f, 0.000000f, 0.064692f, -0.365988f, 0.399297f, 0.044367f, 0.160503f, 0.117358f, -0.071327f, -0.073732f, -0.138846f, 0.190490f, -0.025509f, 0.052647f, 0.023328f},
  {0.034752f, 0.203415f, 0.246559f, 0.070810f, 0.183613f, 0.136699f, 0.073250f, 0.255259f, -0.136504f, -0.195180f, 0.195083f, -0.049234f, 0.177117f, 0.170434f, -0.176955f, 0.197093f, -0.045057f, -0.051204f, 0.039641f, 0.250442f, -0.209424f, 0.043727f, 0.080382f, 0.121793f, 0.151691f, -0.196162f, -0.135293f, 0.032089f, 0.125443f, -0.171952f, -0.122542f, 0.254652f},
  {-0.207110f, 0.179550f, 0.070540f, 0.181955f, -0.247678f, -0.172913f, 0.103151f, 0.106573f, 0.029488f, -0.311703f, 0.072621f, 0.211364f, 0.070351f, 0.219719f, 0.215075f, -0.144840f, -0.297980f, 0.042009f, 0.000000f, 0.044034f, 0.139116f, -0.190673f, -0.103429f, 0.003623f, 0.159063f, -0.031537f, -0.193011f, 0.229239f, 0.111930f, -0.038993f, -0.096475f, 0.232154f},
  {0.142631f, 0.031489f, -0.247278f, -0.145079f, -0.173221f, 0.007617f, -0.176564f, -0.127015f, 0.155979f, 0.038121f, -0.042729f, 0.293195f, -0.131233f, 0.083194f, -0.141361f, -0.097824f, 0.358300f, -0.080141f, 0.000000f, -0.394097f, -0.162381f, 0.176796f, -0.049178f, -0.102714f, 0.086934f, -0.116720f, -0.248957f, 0.091814f, -0.087564f, 0.205475f, 0.192549f, 0.201999f},
  {0.075669f, -0.041318f, -0.094807f, 0.089780f, -0.166460f, 0.025384f, -0.122681f, -0.158716f, 0.018376f, -0.052614f, -0.120033f, -0.049913f, -0.226575f, 0.119583f, -0.262715f, -0.127033f, 0.095406f, -0.370043f, -0.000000f, 0.069458f, -0.049339f, 0.119959f, -0.125177f, -0.171804f, -0.135073f, -0.208066f, 0.209427f, -0.114017f, 0.157075f, 0.194078f, 0.117738f, 0.221668f},
  {-0.092808f, 0.209103f, -0.182408f, 0.096776f, -0.043738f, -0.040943f, 0.024028f, 0.045197f, -0.267622f, -0.235098f, 0.085794f, 0.100562f, 0.389190f, 0.133433f, 0.151045f, 0.082980f, -0.123891f, -0.238950f, 0.094877f, 0.026042f, -0.101092f, -0.064656f, 0.203941f, 0.013124f, -0.046069f, 0.084457f, -0.160546f, 0.037694f, -0.087994f, -0.177551f, 0.210273f, -0.005682f},
  {0.192637f, 0.168923f, -0.036612f, 0.024120f, -0.004984f, 0.114672f, -0.175850f, 0.151167f, 0.025042f, -0.026653f, -0.218104f, 0.099266f, 0.133433f, -0.120425f, 0.072196f, -0.017546f, 0.115599f, 0.039105f, 0.000000f, -0.125644f, -0.030260f, -0.189435f, -0.142698f, 0.035655f, -0.167130f, 0.187252f, -0.165566f, -0.055764f, -0.067288f, -0.342275f, -0.086347f, -0.101319f},
  {-0.050129f, -0.032421f, -0.087871f, 0.107975f, -0.233920f, -0.048158f, 0.224146f, 0.002163f, 0.044275f, -0.201628f, 0.163977f, 0.136982f, -0.008046f, 0.218010f, -0.165835f, -0.245877f, 0.114372f, 0.153018f, -0.180688f, -0.116085f, -0.177851f, -0.107127f, 0.052992f, 0.019023f, -0.053079f, -0.112571f, -0.182832f, -0.108257f, 0.036306f, 0.207292f, 0.188564f, -0.211837f},
  {0.221555f, 0.152686f, 0.105085f, -0.046847f, -0.054721f, -0.139745f, -0.189360f, -0.001796f, -0.220111f, 0.127636f, 0.121774f, -0.001234f, -0.262697f, 0.218922f, 0.239392f, 0.154010f, 0.226181f, 0.319406f, 0.188797f, -0.288323f, 0.028750f, -0.178143f, -0.241819f, -0.151538f, 0.034249f, 0.480520f, 0.124956f, -0.225542f, 0.094445f, 0.073171f, 0.083520f, 0.084878f},
  {0.024850f, -0.035738f, 0.336319f, -0.188523f, 0.084722f, 0.131485f, 0.178101f, -0.114267f, -0.168986f, -0.202529f, 0.063826f, 0.008381f, -0.189509f, 0.246259f, 0.094460f, -0.009244f, -0.042427f, 0.211409f, 0.000000f, -0.027772f, -0.164341f, 0.020422f, 0.055019f, 0.035206f, -0.275097f, -0.002414f, 0.014204f, -0.291468f, -0.255778f, 0.184202f, 0.272466f, 0.075299f},
  {0.174463f, -0.143468f, 0.109980f, -0.106649f, 0.169897f, 0.279577f, 0.011157f, 0.168468f, 0.042059f, -0.128306f, 0.049124f, 0.061551f, -0.258004f, 0.030606f, 0.247658f, -0.174704f, 0.131162f, 0.171934f, 0.123741f, 0.144121f, 0.013842f, 0.179577f, 0.101487f, -0.118287f, 0.037633f, 0.074418f, -0.177084f, 0.049939f, 0.060283f, -0.091751f, -0.049451f, 0.199056f},
  {0.050080f, -0.270997f, -0.207483f, -0.090166f, 0.140967f, -0.180696f, 0.049972f, -0.188184f, -0.216390f, 0.142642f, 0.139474f, -0.107563f, -0.136951f, -0.200929f, -0.043058f, 0.054183f, -0.399337f, 0.013037f, -0.000000f, 0.184779f, 0.350582f, -0.437454f, 0.037327f, -0.091432f, -0.061358f, -0.110539f, 0.205065f, 0.230385f, 0.014460f, 0.016650f, 0.089738f, 0.036722f},
  {0.022031f, -0.035022f, 0.029968f, -0.178894f, -0.140844f, 0.172644f, -0.160297f, -0.027797f, -0.231171f, -0.397073f, -0.177703f, -0.172626f, 0.096232f, -0.140104f, 0.254645f, 0.042425f, -0.080769f, -0.010489f, -0.003081f, 0.174702f, -0.091955f, -0.175023f, 0.145779f, 0.171546f, 0.245710f, -0.091942f, 0.115074f, -0.023514f, -0.041481f, -0.123650f, -0.075311f, -0.089660f}
};

float B2[32] = {
  -0.098839f, 0.227007f, -0.066285f, -0.228253f,
  -0.157454f, 0.181208f, 0.101393f, 0.034826f,
  0.176380f, 0.183638f, -0.090956f, 0.098975f,
  0.129588f, 0.052495f, -0.125379f, 0.220025f,
  -0.022061f, -0.090212f, -0.050999f, -0.201845f,
  -0.247975f, 0.101300f, -0.303484f, 0.004395f,
  0.081095f, -0.254455f, 0.172519f, -0.235940f,
  -0.140341f, -0.068310f, -0.128202f, -0.269466f
};

float W3[32][2] = {
  {0.123467f, 0.351475f},
  {-0.263780f, 0.161312f},
  {0.174602f, 0.298358f},
  {-0.131171f, -0.221411f},
  {-0.165999f, 0.161757f},
  {0.258328f, -0.204353f},
  {-0.210098f, 0.379973f},
  {0.130622f, 0.440998f},
  {0.195881f, -0.170959f},
  {0.043462f, 0.369930f},
  {-0.371346f, 0.054207f},
  {0.227166f, -0.230082f},
  {0.246612f, 0.074177f},
  {0.361942f, -0.372641f},
  {-0.253296f, 0.062205f},
  {-0.108661f, 0.195581f},
  {0.229385f, -0.384784f},
  {0.114189f, 0.144279f},
  {-0.012033f, 0.259911f},
  {0.359520f, -0.200003f},
  {0.218008f, -0.133890f},
  {0.413745f, -0.062119f},
  {0.203434f, 0.290212f},
  {-0.197502f, 0.248332f},
  {-0.302948f, -0.045843f},
  {-0.313347f, 0.488530f},
  {0.267663f, 0.202013f},
  {0.256922f, -0.079708f},
  {0.351888f, -0.009894f},
  {-0.108994f, -0.260532f},
  {0.311441f, 0.210177f},
  {-0.096250f, -0.425869f}
};

float B3[2] = {0.250468f, -0.361807f};
// ==========================================
// *** 가중치 끝 ***
// ==========================================

float lr = 0.01f;
float beta_temp = 0.3f;
float beta_hum  = 2.0f;
const float epsilon = 0.001f;

float hidden1[N_H1];
float hidden2[N_H2];
float pre_h1[N_H1];  // ReLU 미분용 pre-activation
float pre_h2[N_H2];
float pred_scaled[N_OUT];
float last_in_scaled[N_IN];

unsigned long last_sync_unix = 0;
unsigned long sync_millis = 0;

unsigned long last_send_millis = 0;
const unsigned long HEARTBEAT_INTERVAL = 600000;

float relu(float x) { return x > 0.0f ? x : 0.0f; }
float d_relu(float x) { return x > 0.0f ? 1.0f : 0.0f; }

void init_window() {
  for (int w = 0; w < WINDOW_SIZE; w++) {
    window_buf[w][0] = y_mean[0];
    window_buf[w][1] = y_mean[1];
    window_buf[w][2] = 0.5f;
  }
}

void shift_window(float t, float h, float tn) {
  for (int w = 0; w < WINDOW_SIZE - 1; w++) {
    for (int f = 0; f < N_FEATURES; f++) {
      window_buf[w][f] = window_buf[w + 1][f];
    }
  }
  window_buf[WINDOW_SIZE - 1][0] = t;
  window_buf[WINDOW_SIZE - 1][1] = h;
  window_buf[WINDOW_SIZE - 1][2] = tn;
}

void forward() {
  for (int w = 0; w < WINDOW_SIZE; w++) {
    for (int f = 0; f < N_FEATURES; f++) {
      int idx = w * N_FEATURES + f;
      last_in_scaled[idx] = (window_buf[w][f] - x_mean[idx]) / x_std[idx];
    }
  }

  // Input → Hidden1 (64 neurons, ReLU)
  for (int j = 0; j < N_H1; j++) {
    float sum = B1[j];
    for (int i = 0; i < N_IN; i++) sum += last_in_scaled[i] * W1[i][j];
    pre_h1[j] = sum;
    hidden1[j] = relu(sum);
  }

  // Hidden1 → Hidden2 (32 neurons, ReLU)
  for (int j = 0; j < N_H2; j++) {
    float sum = B2[j];
    for (int i = 0; i < N_H1; i++) sum += hidden1[i] * W2[i][j];
    pre_h2[j] = sum;
    hidden2[j] = relu(sum);
  }

  // Hidden2 → Output (2, linear)
  for (int j = 0; j < N_OUT; j++) {
    float sum = B3[j];
    for (int i = 0; i < N_H2; i++) sum += hidden2[i] * W3[i][j];
    pred_scaled[j] = sum;
  }
}

void update_model(float target_t, float target_h) {
  float target_s[2] = {(target_t - y_mean[0]) / y_std[0], (target_h - y_mean[1]) / y_std[1]};
  float out_err[N_OUT];
  for (int i = 0; i < N_OUT; i++) out_err[i] = target_s[i] - pred_scaled[i];

  // --- Output Layer (W3, B3) ---
  for (int i = 0; i < N_OUT; i++) {
    for (int j = 0; j < N_H2; j++) W3[j][i] += lr * out_err[i] * hidden2[j];
    B3[i] += lr * out_err[i];
  }

  // --- Hidden Layer 2 (W2, B2) — ReLU derivative ---
  float h2_delta[N_H2];
  for (int j = 0; j < N_H2; j++) {
    float err_sum = 0.0f;
    for (int i = 0; i < N_OUT; i++) err_sum += out_err[i] * W3[j][i];
    h2_delta[j] = err_sum * d_relu(pre_h2[j]);
  }
  for (int j = 0; j < N_H2; j++) {
    for (int i = 0; i < N_H1; i++) W2[i][j] += lr * h2_delta[j] * hidden1[i];
    B2[j] += lr * h2_delta[j];
  }

  // --- Hidden Layer 1 (W1, B1) — ReLU derivative ---
  float h1_delta[N_H1];
  for (int j = 0; j < N_H1; j++) {
    float err_sum = 0.0f;
    for (int i = 0; i < N_H2; i++) err_sum += h2_delta[i] * W2[j][i];
    h1_delta[j] = err_sum * d_relu(pre_h1[j]);
  }
  for (int j = 0; j < N_H1; j++) {
    for (int i = 0; i < N_IN; i++) W1[i][j] += lr * h1_delta[j] * last_in_scaled[i];
    B1[j] += lr * h1_delta[j];
  }
}

float get_time_n() {
  if (last_sync_unix == 0) return 0.5f;
  unsigned long current_unix = last_sync_unix + (millis() - sync_millis) / 1000;
  long local_sec = (current_unix - 28800) % 86400; // UTC-8
  if (local_sec < 0) local_sec += 86400;
  return (float)local_sec / 86400.0f;
}

String serial_line_buf = "";

void checkSerialTimeSync() {
  while (Serial.available()) {
    char c = Serial.read();
    if (c == '\n') {
      serial_line_buf.trim();
      if (serial_line_buf.startsWith("TIME:")) {
        last_sync_unix = serial_line_buf.substring(5).toInt();
        sync_millis = millis();
      }
      serial_line_buf = "";
    } else if (c != '\r') {
      serial_line_buf += c;
    }
  }
}

void waitForTimeSync() {
  display.clear();
  display.drawString(0, 0, "Syncing Time...");
  display.display();

  int retries = 0;
  while (last_sync_unix == 0) {
    Serial.println("TIME?");

    long start = millis();
    while (millis() - start < 3000) {
      checkSerialTimeSync();
      if (last_sync_unix != 0) break;
      delay(10);
    }

    if (last_sync_unix != 0) {
      display.drawString(0, 20, "Success!");
      display.drawString(0, 40, "TS: " + String(last_sync_unix));
      display.display();
      delay(1000);
      break;
    } else {
      retries++;
      display.drawString(0, 20, "Retry: " + String(retries));
      display.display();
      delay(1000);
    }
  }
}

void setup() {
  Serial.begin(115200);
  pinMode(OLED_RST, OUTPUT); digitalWrite(OLED_RST, HIGH);
  Wire.begin(OLED_SDA, OLED_SCL);
  display.init(); display.flipScreenVertically();

  if (!aht.begin()) { display.drawString(0, 0, "Sensor Error"); display.display(); while (1); }

  SPI.begin(SCK, MISO, MOSI, SS);
  LoRa.setPins(SS, RST, DI0);
  if (!LoRa.begin(BAND)) { display.drawString(0, 0, "LoRa Error"); display.display(); while (1); }

  display.drawString(0, 0, "Model: 12-64-32-2 ReLU");
  display.display();
  delay(1000);

  init_window();
  waitForTimeSync();
  last_send_millis = millis();
}

void loop() {
  sensors_event_t h_event, t_event;
  aht.getEvent(&h_event, &t_event);
  float cur_t = t_event.temperature;
  float cur_h = h_event.relative_humidity;
  float time_n = get_time_n();

  unsigned long t_start = micros();

  forward();

  float pred_t = (pred_scaled[0] * y_std[0]) + y_mean[0];
  float pred_h = (pred_scaled[1] * y_std[1]) + y_mean[1];

  float err_t = fabsf(cur_t - pred_t);
  float err_h = fabsf(cur_h - pred_h);

  bool is_heartbeat = (millis() - last_send_millis >= HEARTBEAT_INTERVAL);
  bool send_data = (err_t >= beta_temp - epsilon) || (err_h >= beta_hum - epsilon) || (last_sync_unix == 0) || is_heartbeat;

  String status = "SKIP";

  if (send_data) {
    if (is_heartbeat && err_t <= beta_temp && err_h <= beta_hum) {
      status = "HEARTBEAT";
    } else {
      status = "SEND & TRAIN";
    }

    last_send_millis = millis();

    unsigned long edge_timestamp_ms = last_sync_unix * 1000UL + (millis() - sync_millis);

    LoRa.beginPacket();
    LoRa.print(String(edge_timestamp_ms) + "," + String(cur_t) + "," + String(cur_h));
    LoRa.endPacket();

    long start = millis();
    while (millis() - start < 1000) {
      int p_size = LoRa.parsePacket();
      if (p_size) {
        String income = "";
        while (LoRa.available()) income += (char)LoRa.read();
        if (income.length() > 5) {
          last_sync_unix = income.toInt();
          sync_millis = millis();
        }
        break;
      }
    }

    update_model(cur_t, cur_h);
  }

  shift_window(pred_t, pred_h, time_n);

  unsigned long t_end = micros();
  unsigned long inference_time_us = t_end - t_start;

  uint32_t free_heap = ESP.getFreeHeap();
  uint32_t total_heap = ESP.getHeapSize();

  display.clear();
  display.drawString(0, 0, "Err T:" + String(err_t, 3) + " H:" + String(err_h, 3));
  display.drawString(0, 15, "P_T:" + String(pred_t, 1) + " P_H:" + String(pred_h, 1));
  display.drawString(0, 30, "R_T:" + String(cur_t, 1) + " R_H:" + String(cur_h, 1));
  display.drawString(0, 45, ">> " + status);
  display.display();

  Serial.println(
    String(cur_t) + "," + String(cur_h) + "," +
    String(pred_t) + "," + String(pred_h) + "," +
    String(err_t, 3) + "," + String(err_h, 3) + "," +
    status + "," +
    String(inference_time_us) + "," + String(free_heap) + "," + String(total_heap)
  );

  Serial.flush();
  LoRa.sleep();

  uint64_t sleep_time_us = 60ULL * 1000ULL * 1000ULL;
  esp_sleep_enable_timer_wakeup(sleep_time_us);
  esp_light_sleep_start();

  display.displayOn();
}
