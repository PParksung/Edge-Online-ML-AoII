# 장애 시 보완 사항

이 문서는 Edge-Online-ML-AoII 프로젝트에서 **장애·일시적 실패**에 대응하기 위해 적용한 보완 사항을 정리한 것이다.

---

## 1. MQTT QoS 혼합 전략 (게이트웨이)

**목적**: 네트워크/브로커 부하 절감과 동시에, 중요한 이벤트(AoII·임계값 초과)는 유실을 줄여 전달.

| 구분 | QoS | 대상 |
|------|-----|------|
| 주기/하트비트 | 0 | EST(60초 주기 예측), 일반 RX(오차가 임계값 미만인 수신) |
| 이벤트 | 1 | 임계값 초과 RX (온도 오차 ≥ 0.5°C 또는 습도 오차 ≥ 3%) |

- **구현 위치**: `gateway/gateway.py`
- **임계값**: `BETA_TEMP = 0.5`, `BETA_HUM = 3.0` (엣지와 동일)
- **효과**: QoS 1은 브로커가 메시지를 보관·재전송하므로, 일시적 단절 시에도 AoII 관련 RX는 복구 가능.

---

## 2. MQTT Publish 실패 시 재시도 (게이트웨이)

**목적**: 일시적 네트워크 끊김·브로커 응답 지연 시 메시지 유실 완화.

- **동작**: `_mqtt_publish()` 내부에서 `publish()` 실패 시 `reconnect()` 후 1회 재발행.
- **구현 위치**: `gateway/gateway.py` 57–67행 — `_mqtt_publish()` 내 try/except 및 `client.reconnect()` 후 재시도.
- **한계**: 재시도 1회만 수행. 지속적 장애 시 로그 출력 후 해당 메시지는 유실.

---

## 3. MySQL Insert 실패 시 지수 백오프 재시도 (서버)

**목적**: DB 일시 불가·연결 끊김 시 RX 이벤트 저장 실패를 줄이기 위함.

- **동작**:
  - `mqtt_to_mysql.py`에서 `aoii/readings` RX 메시지 수신 시 `insert_reading_with_retry()` 호출.
  - 실패 시 **지수 백오프**로 재시도: 1초 → 2초 → 4초 → 8초 → 16초 (최대 5회).
  - 5회 모두 실패 시 로그 출력 후 예외 전파.
- **구현 위치**: `server/mqtt_to_mysql.py` — `INSERT_MAX_RETRIES = 5`, `INSERT_BASE_DELAY = 1.0`.
- **효과**: 짧은 DB 다운/지연 구간에서 자동 복구 가능.

---

## 4. DB·모니터링 시간 일관성

**목적**: CSV·Grafana·DB 조회 시 시간 기준 통일.

- **적용**: `readings`·`edge_log`의 `created_at`을 **로컬 시간**으로 저장 (UTC 아님).
- **구현 위치**: `server/db.py` — `insert_reading()`, `insert_edge_log()`에서 `datetime.now()` 사용 및 docstring에 명시.
- **효과**: 운영·모니터링 시 타임존 혼동 감소.

---

## 5. 설정·운영 보완

| 항목 | 내용 |
|------|------|
| **설정 통일** | DB·MQTT·시리얼 등은 `.env`만 사용. 코드 내 하드코딩 최소화. |
| **Prometheus 저장 경로** | `--storage.tsdb.path`를 프로젝트 밖(예: `/tmp/prometheus_aoii` 또는 `$HOME/prometheus_aoii_data`)으로 지정해 프로젝트 디렉터리 오염 방지. (`MONITORING.md` 참고) |
| **버전 관리 제외** | `.gitignore`에 `data/`, `__pycache__/` 등으로 빌드·런타임 산출물 제외. |

---

## 요약

- **게이트웨이**: QoS 혼합(0/1) + publish 실패 시 reconnect·1회 재시도.
- **서버(MQTT→MySQL)**: insert 실패 시 지수 백오프 최대 5회 재시도.
- **DB/모니터링**: created_at 로컬 시간, .env 기반 설정, Prometheus 데이터 경로 분리.

추가로 필요한 경우: 게이트웨이 publish 다중 재시도·Dead Letter 큐, MySQL 연결 풀·헬스체크, Prometheus 알람(데이터 끊김 등)을 `MONITORING.md` 및 코드에 반영할 수 있다.
